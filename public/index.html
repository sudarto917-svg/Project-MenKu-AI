<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    
    <title>RumahKita</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, getDoc, deleteDoc, updateDoc, onSnapshot, query, where, orderBy, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // BARU: Import untuk Firebase Functions
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";


        const firebaseConfig = {
            apiKey: "AIzaSyDqZrNbvAw1UgWBoAyMohyU2mjRJkH-1iI",
            authDomain: "rumahkita-a17e7.firebaseapp.com",
            projectId: "rumahkita-a17e7",
            storageBucket: "rumahkita-a17e7.firebasestorage.app",
            messagingSenderId: "93467022631",
            appId: "1:93467022631:web:68a46e7965bac6c3ce8502"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // BARU: Inisialisasi Firebase Functions
        const functions = getFunctions(app, 'asia-southeast2'); // PASTIKAN REGION SAMA!


        // --- STATE ---
        let currentUser = null;
        let userProfile = null;
        let currentFamilyId = null; 
        let allTransactions = []; 
        let filteredTransactions = []; 
        let categoryBudgets = {}; 
        let expenseChartInstance = null;
        let viewDate = new Date();
        let isEditing = false;
        let editingId = null;
        let appLoaded = false;

        // --- AUTH LISTENER ---
        // Kita jalankan listener ini segera
        onAuthStateChanged(auth, async (user) => {
            updateLoadingText("Memeriksa akun...");
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                await checkFamilyStatus();
            } else {
                resetState();
                finishLoading(); // Selesai loading, tampilkan login screen
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('family-setup-screen').classList.add('hidden');
            }
        });

        function resetState() {
            currentUser = null; currentFamilyId = null; userProfile = null;
            allTransactions = []; filteredTransactions = [];
        }

        function finishLoading() {
            appLoaded = true;
            document.getElementById('loading-screen').classList.add('hidden');
        }

        function updateLoadingText(text) {
            const el = document.getElementById('loading-text-detail');
            if(el) el.innerText = text;
        }

        async function checkFamilyStatus() {
            try {
                updateLoadingText("Menyiapkan data keluarga...");
                // Timeout manual untuk fetch data jika internet macet
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 10000));
                
                const userDocRef = doc(db, 'users', currentUser.uid);
                // Race antara ambil data vs timeout 10 detik
                const userSnap = await Promise.race([getDoc(userDocRef), timeoutPromise]);

                if (userSnap.exists() && userSnap.data().familyId) {
                    currentFamilyId = userSnap.data().familyId;
                    userProfile = userSnap.data();
                    loadApp();
                } else {
                    finishLoading();
                    document.getElementById('family-setup-screen').classList.remove('hidden');
                }
            } catch (e) { 
                console.error("Error checkFamilyStatus:", e);
                // Jika error/timeout, jangan stuck. Tampilkan error di loading screen agar user bisa logout
                document.getElementById('loading-text-detail').innerText = "Gagal memuat data. Koneksi lambat?";
                document.getElementById('force-logout-container').classList.remove('hidden');
            }
        }

        function loadApp() {
            document.getElementById('family-setup-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            updateProfileUI();
            updateMonthDisplay();

            // Listen Data - Gunakan try catch pada snapshot listener
            try {
                const qTx = query(collection(db, `families/${currentFamilyId}/transactions`));
                onSnapshot(qTx, (snapshot) => {
                    allTransactions = [];
                    snapshot.forEach((doc) => allTransactions.push({ id: doc.id, ...doc.data() }));
                    allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    applyMonthFilter(); 
                    // Data transaksi pertama kali masuk -> Aplikasi Siap
                    if(!appLoaded) finishLoading();
                }, (error) => {
                    console.log("Snapshot Error:", error);
                    // Tetap buka aplikasi meski offline/error, data kosong dulu
                    finishLoading();
                });

                onSnapshot(doc(db, `families/${currentFamilyId}/settings`, 'budgets'), (doc) => {
                    categoryBudgets = doc.exists() ? doc.data() : {};
                    updateDashboard(); 
                });
            } catch (err) {
                console.log("Load App Error", err);
                finishLoading();
            }
        }

        // --- FITUR UTAMA ---
        
        window.changeMonth = (offset) => {
            viewDate.setMonth(viewDate.getMonth() + offset);
            updateMonthDisplay();
            applyMonthFilter();
        };

        function updateMonthDisplay() {
            const options = { month: 'long', year: 'numeric' };
            const dateStr = viewDate.toLocaleDateString('id-ID', options);
            document.getElementById('current-month-display').innerText = dateStr;
            document.getElementById('current-month-display-mobile').innerText = dateStr;
        }

        function applyMonthFilter() {
            const targetMonth = viewDate.getMonth();
            const targetYear = viewDate.getFullYear();
            filteredTransactions = allTransactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getMonth() === targetMonth && tDate.getFullYear() === targetYear;
            });
            updateDashboard();
        }

        function updateProfileUI() {
            const name = userProfile?.displayName || currentUser.email.split('@')[0];
            const role = userProfile?.role ? (userProfile.role === 'suami' ? 'Suami' : 'Istri') : 'Member';
            document.getElementById('header-user-name').innerText = `Halo, ${name}`;
            document.getElementById('header-user-role').innerText = role;
            document.getElementById('family-id-display').innerText = currentFamilyId;
        }

        function updateDashboard() {
            let monthlyIncome = 0, monthlyExpense = 0;
            let totalWalletSuami = 0, totalWalletIstri = 0;
            
            const monthlyExpensesByCategory = {};
            const listContainer = document.getElementById('transaction-list');
            listContainer.innerHTML = '';

            allTransactions.forEach(t => {
                const amt = parseFloat(t.amount);
                if(t.wallet === 'suami') {
                    if(t.type === 'income') totalWalletSuami += amt; else totalWalletSuami -= amt;
                } else if(t.wallet === 'istri') {
                    if(t.type === 'income') totalWalletIstri += amt; else totalWalletIstri -= amt;
                }
            });

            filteredTransactions.forEach(t => {
                const amt = parseFloat(t.amount);
                if (t.type === 'income') {
                    monthlyIncome += amt;
                } else {
                    monthlyExpense += amt;
                    monthlyExpensesByCategory[t.category] = (monthlyExpensesByCategory[t.category] || 0) + amt;
                }
                listContainer.appendChild(createTransactionElement(t));
            });

            document.getElementById('monthly-income').innerText = formatRupiah(monthlyIncome);
            document.getElementById('monthly-expense').innerText = formatRupiah(monthlyExpense);
            document.getElementById('monthly-balance').innerText = formatRupiah(monthlyIncome - monthlyExpense);
            document.getElementById('wallet-suami').innerText = formatRupiah(totalWalletSuami);
            document.getElementById('wallet-istri').innerText = formatRupiah(totalWalletIstri);

            updateCharts(monthlyExpensesByCategory);
            renderBudgetProgress(monthlyExpensesByCategory);
            
            if(filteredTransactions.length === 0) {
                listContainer.innerHTML = `<div class="text-center py-12 text-slate-400 text-sm flex flex-col items-center"><i class="fa-regular fa-folder-open text-2xl mb-2"></i><p>Belum ada transaksi.</p></div>`;
            }
        }

        function createTransactionElement(t) {
            const isIncome = t.type === 'income';
            const div = document.createElement('div');
            div.className = "flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100 hover:border-indigo-100 transition-colors group active:scale-95 transition-transform";
            
            let iconClass = getCategoryIcon(t.category);
            let walletLabel = t.wallet === 'suami' ? 'Suami' : 'Istri';
            let walletColor = t.wallet === 'suami' ? 'text-blue-500 border-blue-200 bg-blue-50' : 'text-pink-500 border-pink-200 bg-pink-50';

            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full ${isIncome ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'} flex items-center justify-center text-lg shadow-sm">
                        <i class="fa-solid ${iconClass}"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-700 text-sm line-clamp-1">${t.title}</h4>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-[10px] border px-1.5 py-0.5 rounded ${walletColor} font-bold"><i class="fa-solid ${t.wallet==='suami'?'fa-mars':'fa-venus'}"></i> ${walletLabel}</span>
                            <span class="text-[10px] text-slate-400">${formatDate(t.date)}</span>
                        </div>
                    </div>
                </div>
                <div class="text-right min-w-[80px]">
                    <span class="block font-bold ${isIncome ? 'text-emerald-600' : 'text-rose-600'} text-sm mb-1">
                        ${isIncome ? '+' : '-'} ${formatRupiah(t.amount)}
                    </span>
                    <div class="flex gap-3 justify-end md:opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="edit-btn text-indigo-400 hover:text-indigo-600 px-1" data-id="${t.id}"><i class="fa-solid fa-pen"></i></button>
                        <button class="delete-btn text-rose-400 hover:text-rose-600 px-1" data-id="${t.id}"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `;
            div.querySelector('.delete-btn').addEventListener('click', async () => { if(confirm('Hapus data ini?')) await deleteDoc(doc(db, `families/${currentFamilyId}/transactions`, t.id)); });
            div.querySelector('.edit-btn').addEventListener('click', () => openEditModal(t));
            return div;
        }

        // --- UTILS & FORM HANDLERS ---

        window.generateReport = () => {
            let inc = 0, exp = 0;
            let catBreakdown = {};
            filteredTransactions.forEach(t => {
                const v = parseFloat(t.amount);
                if(t.type === 'income') inc += v;
                else { exp += v; catBreakdown[t.category] = (catBreakdown[t.category] || 0) + v; }
            });

            document.getElementById('report-period').innerText = viewDate.toLocaleDateString('id-ID', {month:'long', year:'numeric'});
            document.getElementById('report-fam-id').innerText = currentFamilyId;
            document.getElementById('report-inc').innerText = formatRupiah(inc);
            document.getElementById('report-exp').innerText = formatRupiah(exp);
            document.getElementById('report-bal').innerText = formatRupiah(inc - exp);

            const list = document.getElementById('report-cat-list');
            list.innerHTML = '';
            Object.keys(catBreakdown).forEach(c => {
                list.innerHTML += `<div class="flex justify-between text-xs border-b border-slate-100 py-1"><span class="text-slate-600">${c}</span><span class="font-medium text-slate-800">${formatRupiah(catBreakdown[c])}</span></div>`;
            });
            toggleModal('report-modal', true);
        };

        window.downloadPDF = () => {
            const element = document.getElementById('report-content-printable');
            const btn = document.getElementById('btn-dl-pdf');
            const filename = `Laporan_Keuangan_${currentFamilyId}_${document.getElementById('report-period').innerText}.pdf`;
            const opt = { margin: 0.5, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Mengunduh...';
            html2pdf().set(opt).from(element).save().then(() => { btn.innerHTML = '<i class="fa-solid fa-file-pdf"></i> Download PDF'; });
        };
        
        // --- BARU: FITUR AI: FUNCTIONS CALLER ---
        window.getAiAdvice = async () => {
            const btn = document.getElementById('btn-ai-advice');
            const resultDiv = document.getElementById('ai-advice-result');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Koki AI sedang berpikir...';
            resultDiv.innerHTML = ''; // Kosongkan hasil sebelumnya

            try {
                // Kumpulkan data yang dibutuhkan AI
                const incomeText = document.getElementById('monthly-income').innerText;
                const monthlyIncome = parseFloat(incomeText.replace('Rp', '').replace(/\./g, '').replace(/,/g, '.').trim()) || 0;
                
                // Ambil data budget dari STATE yang sudah ada
                const currentBudget = categoryBudgets; 

                // Panggil Firebase Function (Koki AI)
                const callGetAdvice = httpsCallable(functions, 'getSmartBudgetAdvice');
                
                const result = await callGetAdvice({ 
                    totalIncome: monthlyIncome, 
                    currentBudget: currentBudget 
                });

                if (result.data.success) {
                    // Tampilkan hasil saran dari AI
                    const formattedAdvice = result.data.advice.split('*').filter(a => a.trim()).map(a => `<li class="text-slate-700">${a.trim()}</li>`).join('');
                    resultDiv.innerHTML = `<ul class="list-disc pl-5 space-y-2 text-sm">${formattedAdvice}</ul>`;
                } else {
                    resultDiv.innerHTML = `<div class="text-rose-500 text-sm py-2">Error AI: ${result.data.error || 'Terjadi kesalahan saat memproses.'}</div>`;
                }

            } catch (error) {
                console.error("Error calling AI function:", error);
                resultDiv.innerHTML = `<div class="text-rose-500 text-sm py-2">Gagal memanggil fungsi. Pastikan sudah login dan koneksi stabil.</div>`;
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-lightbulb mr-2"></i> Dapatkan Saran Cerdas';
        };
        // --- AKHIR FITUR AI ---


        window.openAddModal = () => {
            isEditing = false; editingId = null;
            document.getElementById('modal-title').innerText = "Tambah Transaksi";
            document.getElementById('btn-save-tx').innerText = "Simpan";
            document.getElementById('tx-form').reset();
            document.getElementById('t-date').valueAsDate = new Date();
            updateCatOptions();
            toggleModal('add-modal', true);
        };

        window.openEditModal = (data) => {
            isEditing = true; editingId = data.id;
            document.getElementById('modal-title').innerText = "Edit Transaksi";
            document.getElementById('btn-save-tx').innerText = "Update";
            document.getElementById('t-title').value = data.title;
            document.getElementById('t-amount').value = data.amount;
            document.getElementById('t-date').value = data.date;
            document.getElementById('t-type').value = data.type;
            updateCatOptions(); 
            document.getElementById('t-category').value = data.category;
            if(data.wallet === 'istri') document.getElementById('wallet-istri-radio').checked = true;
            else document.getElementById('wallet-suami-radio').checked = true;
            toggleModal('add-modal', true);
        };

        window.handleTransactionSubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save-tx');
            btn.disabled = true; btn.innerHTML = 'Menyimpan...';
            try {
                const wallet = document.querySelector('input[name="wallet"]:checked').value;
                const data = {
                    title: document.getElementById('t-title').value,
                    amount: Number(document.getElementById('t-amount').value),
                    date: document.getElementById('t-date').value,
                    type: document.getElementById('t-type').value,
                    category: document.getElementById('t-category').value,
                    wallet: wallet,
                    userEmail: currentUser.email,
                    updatedAt: serverTimestamp()
                };
                if (isEditing && editingId) {
                    await updateDoc(doc(db, `families/${currentFamilyId}/transactions`, editingId), data);
                } else {
                    data.createdAt = serverTimestamp();
                    data.userId = currentUser.uid;
                    await addDoc(collection(db, `families/${currentFamilyId}/transactions`), data);
                }
                toggleModal('add-modal', false);
                const txDate = new Date(data.date);
                if(txDate.getMonth() !== viewDate.getMonth() || txDate.getFullYear() !== viewDate.getFullYear()) {
                    viewDate = txDate; updateMonthDisplay();
                }
            } catch (err) { alert('Gagal menyimpan: ' + err.message); }
            btn.disabled = false; btn.innerHTML = isEditing ? 'Update' : 'Simpan';
        };

        window.openAccountModal = () => {
            document.getElementById('acc-email').value = currentUser.email;
            document.getElementById('acc-family-id').value = currentFamilyId;
            if(userProfile) {
                document.getElementById('acc-name').value = userProfile.displayName || '';
                if(userProfile.role) document.querySelector(`input[name="role"][value="${userProfile.role}"]`).checked = true;
            }
            toggleModal('account-modal', true);
        };

        window.saveProfile = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save-profile');
            btn.innerHTML = 'Menyimpan...';
            const name = document.getElementById('acc-name').value;
            const role = document.querySelector('input[name="role"]:checked')?.value || 'member';
            try {
                await setDoc(doc(db, 'users', currentUser.uid), { displayName: name, role: role }, { merge: true });
                alert('Profil disimpan! Silakan refresh aplikasi jika nama belum berubah.');
                toggleModal('account-modal', false);
            } catch(err) { alert('Gagal menyimpan profil.'); }
            btn.innerText = 'Simpan Profil';
        };

        window.saveSpecificBudget = async (e) => {
            e.preventDefault();
            const inputs = document.querySelectorAll('.budget-input');
            const newBudgets = {};
            inputs.forEach(i => { if(Number(i.value) > 0) newBudgets[i.dataset.category] = Number(i.value); });
            await setDoc(doc(db, `families/${currentFamilyId}/settings`, 'budgets'), newBudgets);
            toggleModal('budget-modal', false);
        };

        function renderBudgetProgress(currentExpenses) {
            const container = document.getElementById('budget-list-container');
            container.innerHTML = '';
            Object.keys(categoryBudgets).forEach(cat => {
                const limit = categoryBudgets[cat]; const used = currentExpenses[cat] || 0; const percent = Math.min((used / limit) * 100, 100);
                let colorClass = percent > 100 ? 'bg-rose-500' : (percent > 75 ? 'bg-yellow-500' : 'bg-emerald-500');
                container.innerHTML += `<div class="mb-4"><div class="flex justify-between items-end mb-1"><span class="text-xs font-bold text-slate-600 flex items-center gap-2"><i class="fa-solid ${getCategoryIcon(cat)} text-slate-400 w-4"></i> ${cat}</span><span class="text-xs font-medium text-slate-600">${formatRupiahShort(used)} / ${formatRupiahShort(limit)}</span></div><div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden"><div class="h-full ${colorClass} transition-all duration-500" style="width: ${percent}%"></div></div></div>`;
            });
        }

        function updateCharts(catData) {
            const ctx = document.getElementById('catChart').getContext('2d');
            if(expenseChartInstance) expenseChartInstance.destroy();
            expenseChartInstance = new Chart(ctx, { type:'doughnut', data:{ labels:Object.keys(catData), datasets:[{ data:Object.values(catData), backgroundColor:['#10b981','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#6366f1'], borderWidth:0 }] }, options:{ responsive:true, plugins:{ legend:{display:false} }, cutout:'75%' } });
        }

        function formatRupiah(n) { return new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}).format(n); }
        function formatRupiahShort(n) { if(n>=1000000) return (n/1000000).toFixed(1)+' Jt'; if(n>=1000) return (n/1000).toFixed(0)+' Rb'; return n; }
        function formatDate(d) { return new Date(d).toLocaleDateString('id-ID', {day:'numeric', month:'short', year:'numeric'}); }
        function getCategoryIcon(c) { const m = {'Makanan':'fa-utensils','Transportasi':'fa-bus','Belanja':'fa-cart-shopping','Tagihan':'fa-bolt','Hiburan':'fa-film','Kesehatan':'fa-notes-medical','Pendidikan':'fa-graduation-cap','Gaji':'fa-money-bill'}; return m[c]||'fa-circle'; }
        
        window.toggleModal = (id, show) => {
            const m = document.getElementById(id);
            show ? (m.classList.remove('hidden'), m.classList.add('flex')) : (m.classList.add('hidden'), m.classList.remove('flex'));
            if(show && id === 'budget-modal') populateBudgetForm();
        };
        window.populateBudgetForm = () => {
            const container = document.getElementById('budget-inputs-container'); container.innerHTML = '';
            ['Makanan','Transportasi','Belanja','Tagihan','Hiburan','Kesehatan','Pendidikan'].forEach(cat => {
                const val = categoryBudgets[cat] || '';
                container.innerHTML += `<div class="flex items-center gap-3 mb-3 bg-slate-50 p-2 rounded-lg border border-slate-100"><div class="w-8 text-center text-indigo-500"><i class="fa-solid ${getCategoryIcon(cat)}"></i></div><div class="flex-1"><label class="text-[10px] font-bold text-slate-400 uppercase block">${cat}</label><input type="number" class="budget-input w-full bg-white border border-slate-200 rounded px-2 py-1 text-sm" placeholder="0" data-category="${cat}" value="${val}"></div></div>`;
            });
        }
        window.updateCatOptions = () => {
            const t = document.getElementById('t-type').value;
            const s = document.getElementById('t-category'); s.innerHTML = '';
            (t==='income'?['Gaji','Bonus','Lainnya']:['Makanan','Transportasi','Belanja','Tagihan','Hiburan','Kesehatan','Pendidikan','Lainnya']).forEach(o=>{const opt=document.createElement('option'); opt.value=o; opt.innerText=o; s.appendChild(opt);});
        }
        
        window.handleLogin=async(e)=>{e.preventDefault();try{await signInWithEmailAndPassword(auth,document.getElementById('email').value,document.getElementById('password').value);}catch(e){alert("Gagal: "+e.message)}};
        window.handleRegister=async()=>{try{await createUserWithEmailAndPassword(auth,document.getElementById('email').value,document.getElementById('password').value);}catch(e){alert("Gagal: "+e.message)}};
        window.handleLogout=()=>signOut(auth);
        window.forceLogout = () => {
            signOut(auth).then(() => {
                window.location.reload();
            });
        };
        window.reloadApp = () => window.location.reload();

        window.submitCreateFamily=async(e)=>{e.preventDefault();try{const c=document.getElementById('new-family-name').value.trim().replace(/\s+/g,'-').toUpperCase();await setDoc(doc(db,'families',c),{createdAt:serverTimestamp()});await setDoc(doc(db,'users',currentUser.uid),{familyId:c,role:'suami'},{merge:true});window.location.reload();}catch(e){alert("Gagal: "+e.message)}};
        window.submitJoinFamily=async(e)=>{e.preventDefault();try{const c=document.getElementById('join-family-code').value.trim().toUpperCase();const s=await getDoc(doc(db,'families',c));if(s.exists()){await setDoc(doc(db,'users',currentUser.uid),{familyId:c,role:'istri'},{merge:true});window.location.reload();}else{alert("Kode Salah")}}catch(e){alert("Error")}};
        window.openCreateFamilyModal=()=>toggleModal('create-family-modal',true);
        window.openJoinFamilyModal=()=>toggleModal('join-family-modal',true);

        // --- SAFETY TIMER (PENTING) ---
        // Jika loading lebih dari 8 detik, tampilkan tombol darurat
        setTimeout(() => {
            const loader = document.getElementById('loading-screen');
            if (!loader.classList.contains('hidden')) {
                updateLoadingText("Koneksi lambat...");
                document.getElementById('force-logout-container').classList.remove('hidden');
            }
        }, 8000);

    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Mobile Optimizations */
        input, select, button { font-size: 16px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col md:flex-row overflow-hidden select-none">

    <div id="loading-screen" class="fixed inset-0 z-[100] bg-indigo-600 flex flex-col items-center justify-center text-white px-4 transition-all duration-500">
        <div class="text-center animate-pulse mb-8">
            <i class="fa-solid fa-house-chimney text-6xl mb-6"></i>
            <h2 class="font-bold text-3xl mb-2">RumahKita</h2>
            <p class="text-indigo-200 text-sm" id="loading-text-detail">Memuat aplikasi...</p>
        </div>
        
        <div id="force-logout-container" class="hidden flex flex-col gap-3 w-full max-w-xs">
            <p class="text-center text-xs text-indigo-200 mb-2">Aplikasi tidak merespon?</p>
            <button onclick="reloadApp()" class="bg-white text-indigo-600 py-3 px-6 rounded-xl font-bold text-sm shadow-lg active:scale-95 transition">
                <i class="fa-solid fa-rotate-right mr-2"></i> Muat Ulang
            </button>
            <button onclick="forceLogout()" class="bg-rose-500 text-white py-3 px-6 rounded-xl font-bold text-sm shadow-lg active:scale-95 transition">
                <i class="fa-solid fa-right-from-bracket mr-2"></i> Keluar Paksa (Logout)
            </button>
        </div>
    </div>

    <div id="auth-screen" class="hidden fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl text-center">
            <i class="fa-solid fa-shield-heart text-4xl text-indigo-600 mb-4"></i>
            <h1 class="text-2xl font-bold mb-6">Login Keluarga</h1>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full p-3 rounded-xl border text-sm">
                <input type="password" id="password" placeholder="Password" class="w-full p-3 rounded-xl border text-sm">
                <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl active:bg-indigo-800">Masuk</button>
                <button type="button" onclick="handleRegister()" class="w-full py-3 border font-bold rounded-xl text-slate-600 active:bg-slate-100">Daftar</button>
            </form>
        </div>
    </div>

    <div id="family-setup-screen" class="hidden fixed inset-0 z-50 bg-slate-50 flex items-center justify-center p-4">
        <div class="max-w-sm w-full text-center space-y-4">
            <h2 class="text-2xl font-bold">Atur Keluarga</h2>
            <button onclick="openCreateFamilyModal()" class="w-full bg-white p-6 rounded-2xl shadow hover:border-indigo-500 border transition font-bold text-indigo-600"><i class="fa-solid fa-plus block text-2xl mb-2"></i> Buat Keluarga Baru</button>
            <button onclick="openJoinFamilyModal()" class="w-full bg-white p-6 rounded-2xl shadow hover:border-emerald-500 border transition font-bold text-emerald-600"><i class="fa-solid fa-link block text-2xl mb-2"></i> Gabung Keluarga</button>
            <button onclick="forceLogout()" class="text-slate-400 text-xs mt-4 underline">Logout</button>
        </div>
    </div>

    <div id="app-screen" class="hidden flex-1 flex flex-col md:flex-row h-full relative">
        <aside class="hidden md:flex flex-col w-64 bg-white border-r h-full p-6 justify-between z-20">
            <div>
                <div class="flex items-center gap-3 mb-8 text-indigo-600"><i class="fa-solid fa-house-chimney text-2xl"></i><span class="font-bold text-xl">RumahKita</span></div>
                <div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-4 rounded-2xl mb-6 shadow-lg shadow-indigo-200">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-lg"><i class="fa-solid fa-user"></i></div>
                        <div><p class="text-sm font-bold" id="header-user-name">Halo...</p><p class="text-[10px] bg-black/20 px-2 rounded-full inline-block" id="header-user-role">Anggota</p></div>
                    </div>
                    <div class="flex items-center justify-between bg-white/10 rounded-lg px-2 py-1 mt-2"><span class="text-[10px] opacity-80">ID: <span id="family-id-display" class="font-mono">...</span></span><i class="fa-regular fa-copy cursor-pointer text-xs hover:text-white hover:scale-110 transition" onclick="navigator.clipboard.writeText(document.getElementById('family-id-display').innerText); alert('ID Disalin!')"></i></div>
                </div>
                <nav class="space-y-2">
                    <a href="#" class="flex items-center gap-3 px-3 py-2 bg-slate-800 text-white rounded-xl text-sm font-medium"><i class="fa-solid fa-chart-pie w-5 text-center"></i> Dashboard</a>
                    <a href="#" onclick="generateReport()" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl text-sm font-medium"><i class="fa-solid fa-file-pdf w-5 text-center"></i> Laporan PDF</a>
                    <a href="#" onclick="toggleModal('budget-modal', true)" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl text-sm font-medium"><i class="fa-solid fa-scale-balanced w-5 text-center"></i> Budgeting</a>
                    <a href="#" onclick="openAccountModal()" class="flex items-center gap-3 px-3 py-2 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl text-sm font-medium"><i class="fa-solid fa-user-gear w-5 text-center"></i> Akun & Profil</a>
                </nav>
            </div>
            <button onclick="handleLogout()" class="flex items-center gap-3 text-slate-400 hover:text-rose-600 text-sm font-medium px-3"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </aside>

        <main class="flex-1 h-full overflow-y-auto p-4 md:p-8 pb-24 bg-slate-50">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 pt-safe">
                <div class="flex items-center justify-between w-full md:w-auto">
                    <span class="md:hidden font-bold text-indigo-600 text-lg">RumahKita</span>
                    <div class="flex items-center gap-3 bg-white px-3 py-2 rounded-xl shadow-sm border border-slate-200 mx-auto md:mx-0">
                        <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 active:text-indigo-600"><i class="fa-solid fa-chevron-left"></i></button>
                        <div class="text-center"><p class="text-[10px] font-bold text-slate-400 uppercase">Periode</p><p class="font-bold text-indigo-700 min-w-[100px] text-center text-sm" id="current-month-display">...</p></div>
                        <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 active:text-indigo-600"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div class="md:hidden flex gap-3">
                         <button onclick="generateReport()" class="text-slate-500 w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm"><i class="fa-solid fa-file-pdf"></i></button>
                        <button onclick="openAccountModal()" class="text-slate-500 w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm"><i class="fa-solid fa-user-gear"></i></button>
                    </div>
                </div>
                <button onclick="handleLogout()" class="hidden md:block text-rose-500 hover:bg-rose-50 px-3 py-2 rounded-lg transition"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
            </div>

            <h3 class="font-bold text-slate-700 mb-3 text-xs uppercase tracking-wider">Arus Kas <span id="current-month-display-mobile" class="md:hidden"></span></h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-5 rounded-2xl shadow-lg relative overflow-hidden">
                    <p class="text-indigo-100 text-xs mb-1">Sisa Uang (Bulan Ini)</p>
                    <h2 class="text-3xl font-bold" id="monthly-balance">Rp 0</h2>
                    <div class="mt-4 flex gap-4 text-xs opacity-80">
                        <div><i class="fa-solid fa-arrow-down"></i> Masuk: <span id="monthly-income">0</span></div>
                        <div><i class="fa-solid fa-arrow-up"></i> Keluar: <span id="monthly-expense">0</span></div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                    <div class="flex justify-between items-start"><div><p class="text-slate-400 text-xs font-bold uppercase mb-1">Dompet Suami</p><h2 class="text-xl font-bold text-blue-600" id="wallet-suami">Rp 0</h2></div><div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center text-blue-600"><i class="fa-solid fa-mars"></i></div></div>
                    <div class="absolute bottom-0 left-0 w-full h-1 bg-blue-500 opacity-50"></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                    <div class="flex justify-between items-start"><div><p class="text-slate-400 text-xs font-bold uppercase mb-1">Dompet Istri</p><h2 class="text-xl font-bold text-pink-600" id="wallet-istri">Rp 0</h2></div><div class="w-8 h-8 bg-pink-50 rounded-full flex items-center justify-center text-pink-600"><i class="fa-solid fa-venus"></i></div></div>
                    <div class="absolute bottom-0 left-0 w-full h-1 bg-pink-500 opacity-50"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm border border-slate-100 min-h-[400px]">
                    <h3 class="font-bold text-slate-700 mb-6 flex items-center gap-2 text-sm"><i class="fa-solid fa-receipt text-indigo-500"></i> Riwayat Transaksi</h3>
                    <div id="transaction-list" class="space-y-3 max-h-[500px] overflow-y-auto no-scrollbar pr-1"></div>
                </div>
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-700 text-xs uppercase mb-4">Saran Keuangan Cerdas</h3>
                        <button id="btn-ai-advice" onclick="getAiAdvice()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg active:bg-emerald-700 active:scale-95 transition mb-4">
                            <i class="fa-solid fa-lightbulb mr-2"></i> Dapatkan Saran Cerdas
                        </button>
                        <div id="ai-advice-result">
                            <p class="text-xs text-slate-400">Tekan tombol di atas setelah mengatur budget.</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-700 mb-4 text-xs uppercase">Pengeluaran</h3>
                        <div class="w-40 h-40 mx-auto"><canvas id="catChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-700 text-xs uppercase">Budgeting</h3><button onclick="toggleModal('budget-modal', true)" class="text-xs text-indigo-600 font-bold">Edit</button></div>
                        <div id="budget-list-container" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </main>
        
        <button onclick="openAddModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-xl flex items-center justify-center text-2xl active:scale-95 transition z-40"><i class="fa-solid fa-plus"></i></button>
    </div>

    <div id="report-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-4"><h3 class="font-bold text-lg">Laporan Bulanan</h3><button onclick="toggleModal('report-modal', false)"><i class="fa-solid fa-xmark"></i></button></div>
            <div id="report-content-printable" class="flex-1 overflow-y-auto p-2 bg-white">
                <div class="text-center mb-6 border-b-2 border-slate-800 pb-4"><h2 class="text-2xl font-bold text-slate-800 uppercase tracking-wider">Laporan Keuangan</h2><p class="text-sm text-slate-500" id="report-period">...</p><p class="text-xs text-slate-400 mt-1">Keluarga: <span id="report-fam-id">RumahKita</span></p></div>
                <div class="grid grid-cols-2 gap-4 mb-6"><div class="bg-emerald-50 p-4 rounded-xl text-center border border-emerald-100"><p class="text-xs text-emerald-600 font-bold uppercase mb-1">Total Pemasukan</p><p class="font-bold text-lg text-slate-800" id="report-inc">0</p></div><div class="bg-rose-50 p-4 rounded-xl text-center border border-rose-100"><p class="text-xs text-rose-600 font-bold uppercase mb-1">Total Pengeluaran</p><p class="font-bold text-lg text-slate-800" id="report-exp">0</p></div></div>
                <div class="bg-slate-100 p-4 rounded-xl flex justify-between items-center mb-8"><span class="font-bold text-slate-600">Sisa Arus Kas</span><span class="font-bold text-xl text-indigo-600" id="report-bal">0</span></div>
                <h4 class="font-bold text-sm text-slate-700 border-b mb-3 pb-1">Rincian Kategori</h4>
                <div id="report-cat-list" class="space-y-2 mb-8"></div>
                <div class="text-center text-[10px] text-slate-300 mt-8">Dicetak otomatis melalui Aplikasi RumahKita</div>
            </div>
            <button id="btn-dl-pdf" onclick="downloadPDF()" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-3 mt-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:bg-rose-800"><i class="fa-solid fa-file-pdf"></i> Download PDF</button>
        </div>
    </div>

    <div id="account-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6 border-b pb-4"><h3 class="font-bold text-lg">Profil Akun</h3><button onclick="toggleModal('account-modal', false)"><i class="fa-solid fa-xmark"></i></button></div>
            <form onsubmit="saveProfile(event)" class="space-y-4">
                <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-center mb-4"><p class="text-[10px] uppercase font-bold text-indigo-400 mb-1">Kode Keluarga Anda</p><input type="text" id="acc-family-id" readonly class="bg-transparent font-mono font-bold text-xl text-indigo-700 text-center w-full outline-none"></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email Login</label><input type="text" id="acc-email" readonly class="w-full bg-slate-100 border border-slate-200 p-3 rounded-xl text-sm text-slate-500"></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Panggilan</label><input type="text" id="acc-name" placeholder="Contoh: Ayah Budi" required class="w-full border border-slate-200 p-3 rounded-xl text-sm focus:border-indigo-500 outline-none"></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Peran</label><div class="grid grid-cols-2 gap-3"><label class="cursor-pointer"><input type="radio" name="role" value="suami" class="peer sr-only"><div class="peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-600 border border-slate-200 rounded-xl p-3 text-center text-sm font-bold text-slate-400"><i class="fa-solid fa-mars mr-1"></i> Suami</div></label><label class="cursor-pointer"><input type="radio" name="role" value="istri" class="peer sr-only"><div class="peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-600 border border-slate-200 rounded-xl p-3 text-center text-sm font-bold text-slate-400"><i class="fa-solid fa-venus mr-1"></i> Istri</div></label></div></div>
                <button id="btn-save-profile" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold mt-2 shadow-lg active:bg-slate-900">Simpan Profil</button>
                <button type="button" onclick="forceLogout()" class="w-full py-3 text-rose-500 font-bold text-xs">Logout Akun</button>
            </form>
        </div>
    </div>

    <div id="add-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 backdrop-blur-sm items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg" id="modal-title">Transaksi</h3><button onclick="toggleModal('add-modal', false)"><i class="fa-solid fa-xmark"></i></button></div><form id="tx-form" onsubmit="handleTransactionSubmit(event)" class="space-y-4"><div class="grid grid-cols-2 bg-slate-100 p-1 rounded-xl gap-1"><button type="button" onclick="document.getElementById('t-type').value='income';updateCatOptions();this.className='flex-1 py-2 rounded-lg text-sm font-bold bg-white text-emerald-600 shadow-sm';this.nextElementSibling.className='flex-1 py-2 rounded-lg text-sm font-medium text-slate-400';" class="flex-1 py-2 rounded-lg text-sm font-medium text-slate-400">Pemasukan</button><button type="button" onclick="document.getElementById('t-type').value='expense';updateCatOptions();this.className='flex-1 py-2 rounded-lg text-sm font-bold bg-white text-rose-600 shadow-sm';this.previousElementSibling.className='flex-1 py-2 rounded-lg text-sm font-medium text-slate-400';" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white text-rose-600 shadow-sm">Pengeluaran</button><input type="hidden" id="t-type" value="expense"></div><div class="grid grid-cols-2 gap-3"><label class="cursor-pointer"><input type="radio" name="wallet" value="suami" id="wallet-suami-radio" class="peer sr-only" checked><div class="peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-600 border border-slate-200 rounded-xl p-2 text-center text-xs font-bold text-slate-400"><i class="fa-solid fa-mars"></i> Suami</div></label><label class="cursor-pointer"><input type="radio" name="wallet" value="istri" id="wallet-istri-radio" class="peer sr-only"><div class="peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-600 border border-slate-200 rounded-xl p-2 text-center text-xs font-bold text-slate-400"><i class="fa-solid fa-venus"></i> Istri</div></label></div><input type="text" id="t-title" placeholder="Judul" required class="w-full border p-3 rounded-xl text-sm"><div class="grid grid-cols-2 gap-3"><input type="number" id="t-amount" placeholder="Rp" required class="w-full border p-3 rounded-xl text-sm"><input type="date" id="t-date" required class="w-full border p-3 rounded-xl text-sm"></div><div class="relative"><select id="t-category" class="w-full border p-3 rounded-xl text-sm bg-white appearance-none"></select><i class="fa-solid fa-chevron-down absolute right-4 top-4 text-xs text-slate-400 pointer-events-none"></i></div><button id="btn-save-tx" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg active:bg-indigo-800">Simpan</button></form></div></div>
    <div id="budget-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-2xl p-6 flex flex-col max-h-[85vh]"><div class="flex justify-between mb-4"><h3 class="font-bold">Atur Budget</h3><button onclick="toggleModal('budget-modal',false)"><i class="fa-solid fa-xmark"></i></button></div><form onsubmit="saveSpecificBudget(event)" class="flex-1 overflow-y-auto"><div id="budget-inputs-container"></div><button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold mt-4 active:bg-indigo-800">Simpan</button></form></div></div>
    
    <div id="create-family-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-2xl p-6"><h3 class="font-bold text-lg mb-4">Buat Keluarga</h3><form onsubmit="submitCreateFamily(event)"><input type="text" id="new-family-name" placeholder="Nama Keluarga (Tanpa Spasi)" required class="w-full border p-3 rounded-xl text-sm mb-4"><button class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl active:bg-indigo-800">Buat</button><button type="button" onclick="toggleModal('create-family-modal',false)" class="w-full py-3 mt-2 text-slate-500">Batal</button></form></div></div>
    <div id="join-family-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-2xl p-6"><h3 class="font-bold text-lg mb-4">Gabung Keluarga</h3><form onsubmit="submitJoinFamily(event)"><input type="text" id="join-family-code" placeholder="Kode Keluarga" required class="w-full border p-3 rounded-xl text-sm mb-4"><button class="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl active:bg-emerald-800">Gabung</button><button type="button" onclick="toggleModal('join-family-modal',false)" class="w-full py-3 mt-2 text-slate-500">Batal</button></form></div></div>

</body>
</html>
